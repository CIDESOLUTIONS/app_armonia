// Esquema Prisma para el sistema PQR avanzado
// Este esquema extiende el modelo básico de PQR con funcionalidades avanzadas

// Enumeración para categorías de PQR
enum PQRType {
  PETITION
  COMPLAINT
  CLAIM
  SUGGESTION

  @@schema("tenant")
}

enum PQRImpact {
  LOW
  MEDIUM
  HIGH

  @@schema("tenant")
}

// Modelo principal para PQR avanzado
model PQR {
  id                Int               @id @default(autoincrement())
  ticketNumber      String            // Número único de ticket (ej: PQR-20250602-001)
  type              PQRType           // Tipo: petición, queja, reclamo, sugerencia
  title             String            // Título descriptivo
  description       String            // Descripción detallada
  
  // Categorización y priorización
  category          PQRCategory       // Categoría principal
  subcategory       String?           // Subcategoría (opcional)
  priority          PQRPriority       // Prioridad asignada
  impact            PQRImpact?        // Impacto (Alto, Medio, Bajo)
  
  // Estado y asignación
  status            PQRStatus         @default(OPEN) // Estado actual
  assignedToId      Int?              // ID del responsable asignado
  assignedTo        User?             @relation("AssignedPqrs", fields: [assignedToId], references: [id])
  assignedTeamId    Int?              // ID del equipo asignado
  assignedTeam      PQRTeam?          @relation(fields: [assignedTeamId], references: [id])
  
  // Fechas y tiempos
  createdAt         DateTime          @default(now()) // Fecha de creación
  updatedAt         DateTime          @updatedAt      // Última actualización
  submittedAt       DateTime          @default(now()) // Fecha de envío
  assignedAt        DateTime?         // Fecha de asignación
  startedAt         DateTime?         // Fecha de inicio de atención
  resolvedAt        DateTime?         // Fecha de resolución
  closedAt          DateTime?         // Fecha de cierre
  dueDate           DateTime?         // Fecha límite según SLA
  
  // Usuario y unidad
  userId            Int               // ID del usuario que reporta
  user              User              @relation("ReportedPqrs", fields: [userId], references: [id])
  propertyId        Int?              // ID de la unidad relacionada
  property          Property?         @relation(fields: [propertyId], references: [id])
  complexId         Int               // ID del conjunto residencial
  complex           ResidentialComplex @relation(fields: [complexId], references: [id])
  
  // Resolución
  resolution        String?           // Descripción de la resolución
  satisfactionRating Int?             // Calificación de satisfacción (1-5)
  satisfactionComment String?         // Comentario sobre la satisfacción
  
  // Métricas y SLA
  responseTime      Int?              // Tiempo de primera respuesta (minutos)
  resolutionTime    Int?              // Tiempo total de resolución (minutos)
  slaId             Int?              // ID del SLA aplicable
  sla               PQRSLA?           @relation(fields: [slaId], references: [id])
  slaBreached       Boolean?          // Si se incumplió el SLA
  
  // Etiquetas y clasificación
  isPrivate         Boolean           @default(false) // Si es visible solo para administradores
  requiresFollowUp  Boolean           @default(false) // Si requiere seguimiento posterior
  tags              String[]          // Etiquetas para categorización
  
  // Relaciones
  statusHistory     PQRStatusHistory[] // Historial de estados
  comments          PQRComment[]      // Comentarios
  attachments       PQRAttachment[]   // Archivos adjuntos
  notifications     PQRNotification[] // Notificaciones enviadas
  
  // Índices para optimización
  @@index([status])
  @@index([category])
  @@index([priority])
  @@index([assignedToId])
  @@index([userId])
  @@index([complexId])
  @@index([ticketNumber])
  @@index([propertyId])
  @@index([slaId])
  
  @@schema("tenant")
}

// Modelo para historial de estados de PQR
model PQRStatusHistory {
  id                Int               @id @default(autoincrement())
  pqrId             Int               // ID del PQR
  pqr               PQR               @relation(fields: [pqrId], references: [id])
  previousStatus    PQRStatus?        // Estado anterior
  newStatus         PQRStatus         // Nuevo estado
  changedAt         DateTime          @default(now()) // Fecha del cambio
  changedById       Int               // ID del usuario que realizó el cambio
  changedBy         User              @relation("PQRStatusChanges", fields: [changedById], references: [id])
  comment           String?           // Comentario sobre el cambio
  timeInStatus      Int?              // Tiempo en el estado anterior (minutos)
  
  @@index([pqrId])
  @@index([changedAt])
  @@index([changedById])
  
  @@schema("tenant")
}

// Modelo para comentarios en PQR
model PQRComment {
  id                Int               @id @default(autoincrement())
  pqrId             Int               // ID del PQR
  pqr               PQR               @relation(fields: [pqrId], references: [id])
  content           String            // Contenido del comentario
  authorId          Int               // ID del autor
  author            User              @relation("PQRComments", fields: [authorId], references: [id])
  isInternal        Boolean           @default(false) // Si es visible solo para administradores
  createdAt         DateTime          @default(now()) // Fecha de creación
  
  @@index([pqrId])
  @@index([createdAt])
  @@index([authorId])
  
  @@schema("tenant")
}

// Modelo para archivos adjuntos en PQR
model PQRAttachment {
  id                Int               @id @default(autoincrement())
  pqrId             Int               // ID del PQR
  pqr               PQR               @relation(fields: [pqrId], references: [id])
  fileName          String            // Nombre del archivo
  fileUrl           String            // URL del archivo
  fileType          String            // Tipo de archivo (imagen, documento, etc.)
  fileSize          Int               // Tamaño en bytes
  uploadedAt        DateTime          @default(now()) // Fecha de subida
  uploadedById      Int               // ID del usuario que subió el archivo
  uploadedBy        User              @relation("PQRAttachments", fields: [uploadedById], references: [id])
  
  @@index([pqrId])
  @@index([uploadedById])
  
  @@schema("tenant")
}

// Modelo para notificaciones de PQR
model PQRNotification {
  id                Int               @id @default(autoincrement())
  pqrId             Int               // ID del PQR
  pqr               PQR               @relation(fields: [pqrId], references: [id])
  type              String            // Tipo de notificación (email, sms, push, etc.)
  recipientId       Int               // ID del destinatario
  recipient         User              @relation("PQRNotifications", fields: [recipientId], references: [id])
  subject           String            // Asunto
  content           String            // Contenido
  sentAt            DateTime          @default(now()) // Fecha de envío
  status            String            // Estado (enviado, entregado, leído, fallido)
  
  @@index([pqrId])
  @@index([sentAt])
  @@index([recipientId])
  
  @@schema("tenant")
}

// Modelo para SLA de PQR
model PQRSLA {
  id                Int               @id @default(autoincrement())
  name              String            // Nombre del SLA
  description       String?           // Descripción
  category          PQRCategory?      // Categoría aplicable (null = todas)
  priority          PQRPriority?      // Prioridad aplicable (null = todas)
  responseTime      Int               // Tiempo de respuesta objetivo (minutos)
  resolutionTime    Int               // Tiempo de resolución objetivo (minutos)
  businessHoursOnly Boolean           @default(true) // Si aplica solo en horario laboral
  escalationRules   Json?             // Reglas de escalamiento
  isActive          Boolean           @default(true) // Si está activo
  complexId         Int
  complex           ResidentialComplex @relation(fields: [complexId], references: [id])
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@index([complexId])
  @@schema("tenant")
}

// Modelo para equipos de atención de PQR
model PQRTeam {
  id                Int               @id @default(autoincrement())
  name              String            // Nombre del equipo
  description       String?           // Descripción
  members           PQRTeamMember[]   // Miembros del equipo
  categories        PQRCategory[]     // Categorías que atiende
  isActive          Boolean           @default(true) // Si está activo
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@schema("tenant")
}

model PQRTeamMember {
  id                Int               @id @default(autoincrement())
  teamId            Int
  team              PQRTeam           @relation(fields: [teamId], references: [id])
  userId            Int
  user              User              @relation("PQRTeamMembers", fields: [userId], references: [id])
  assignedAt        DateTime          @default(now())

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@schema("tenant")
}

// Modelo para reglas de asignación automática
model PQRAssignmentRule {
  id                Int               @id @default(autoincrement())
  name              String            // Nombre de la regla
  description       String?           // Descripción
  isActive          Boolean           @default(true) // Si está activa
  priority          Int               // Prioridad de la regla (orden de evaluación)
  complexId         Int
  complex           ResidentialComplex @relation(fields: [complexId], references: [id])
  
  // Condiciones
  categories        PQRCategory[]     // Categorías a las que aplica
  priorities        PQRPriority[]     // Prioridades a las que aplica
  keywords          String[]          // Palabras clave en título o descripción
  
  // Acción
  assignToTeamId    Int?              // ID del equipo a asignar
  assignToTeam      PQRTeam?          @relation(fields: [assignToTeamId], references: [id])
  assignToUserId    Int?              // ID del usuario a asignar
  assignToUser      User?             @relation("PQRRuleAssignedUsers", fields: [assignToUserId], references: [id])
  setPriority       PQRPriority?      // Prioridad a establecer
  setDueDate        String?           // Expresión para calcular fecha límite
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@index([complexId])
  @@index([assignToTeamId])
  @@index([assignToUserId])
  @@schema("tenant")
}

// Modelo para configuración del sistema PQR
model PQRSettings {
  id                      Int       @id @default(autoincrement())
  complexId               Int       @unique
  complex                 ResidentialComplex @relation(fields: [complexId], references: [id])
  autoAssignEnabled       Boolean   @default(true)  // Asignación automática
  autoCategorizeEnabled   Boolean   @default(true)  // Categorización automática
  autoNotifyEnabled       Boolean   @default(true)  // Notificaciones automáticas
  satisfactionSurveyEnabled Boolean  @default(true)  // Encuesta de satisfacción
  allowAnonymousReports   Boolean   @default(false) // Permitir reportes anónimos
  requireApprovalToClose  Boolean   @default(true)  // Requiere aprobación para cerrar
  defaultPriority         PQRPriority @default(MEDIUM) // Prioridad predeterminada
  updatedAt               DateTime  @updatedAt
  
  @@index([complexId])
  @@schema("tenant")
}

// Modelo para categorías personalizadas
model PQRCustomCategory {
  id                Int       @id @default(autoincrement())
  name              String    // Nombre de la categoría
  parentCategory    PQRCategory // Categoría principal
  description       String?   // Descripción
  isActive          Boolean   @default(true) // Si está activa
  complexId         Int
  complex           ResidentialComplex @relation(fields: [complexId], references: [id])
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([complexId])
  @@schema("tenant")
}

// Modelo para plantillas de respuesta
model PQRResponseTemplate {
  id                Int       @id @default(autoincrement())
  name              String    // Nombre de la plantilla
  category          PQRCategory? // Categoría aplicable
  subject           String    // Asunto
  content           String    // Contenido
  isActive          Boolean   @default(true) // Si está activa
  complexId         Int
  complex           ResidentialComplex @relation(fields: [complexId], references: [id])
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([complexId])
  @@schema("tenant")
}

// Modelo para reportes y métricas
model PQRReport {
  id                Int       @id @default(autoincrement())
  name              String    // Nombre del reporte
  type              String    // Tipo (diario, semanal, mensual, personalizado)
  parameters        Json      // Parámetros del reporte
  schedule          String?   // Programación (expresión cron)
  recipients        String[]  // Destinatarios
  lastRun           DateTime? // Última ejecución
  complexId         Int
  complex           ResidentialComplex @relation(fields: [complexId], references: [id])
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([complexId])
  @@schema("tenant")
}
